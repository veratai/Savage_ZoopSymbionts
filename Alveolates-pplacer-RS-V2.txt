
# pplacer for Alveolata ASVs from Zoop symbiont MS
# 20221125
# Rosie Savage 

##Make fasta from pr2 metadata merged file 

python pr2_merged_to_fasta.py -t pr2_version_4.12.0_trim.txt -o pr2_taxa_symbiont_meta.fas

tr "[ -%,;\(\):=\.\\\*[]\"\']" "_" <  pr2_taxa_symbiont_meta.fas  > pr2_taxa_symbiont_clean_meta.fas

# remove duplicate IDS 

python3  ~/PythonScripts/Remove_same_id.py -f pr2_taxa_symbiont_clean_meta.fas -o pr2_taxa_symbiont_noDupID_meta.fasta

# remove duplicate sequences from trimmed seqsrm 

python3  ~/PythonScripts/DupSequencesRemoval.py -f pr2_taxa_symbiont_noDupID_meta.fasta -o pr2_taxa_symbiont_noDupSeq_meta.fas
###lost 50 parasite sequences

## Grep alveolates 
grep Alveolata  -A1 pr2_taxa_symbiont_noDupSeq_meta.fas  --no-group-separator > alv_symbiont.fas


##PPLACER REFERENCE TREEEE

## Align sequeunces with mafft

mafft --thread 8 alv_symbiont.fas > alv_symbiont_mafft.fas


##HOW TO LOOK AT ALIGNMENT 

## rerun raxml on reduced file generated by raxml, before this append symbiont role to taxonomy from v9 taraoceans 

## Build reference tree from alignment, use RAxML
#to get reduced file 
raxmlHPC-PTHREADS-AVX2 -T 8 -m GTRGAMMA -s  alv_symbiont_ref_mafft.fasta -n alv.red.tre -f d -p 12345 


## Root the tree and get conifdence scores 
raxmlHPC-PTHREADS-AVX2 -T 2 -m GTRGAMMA -f I -t RAxML_bestTree.alv.red.tre  -n root.ref.tre

## Generate confidence scores for tree
raxmlHPC-PTHREADS-AVX2 -T 8 -m GTRGAMMA -f J -p 12345 -t  RAxML_rootedTree.root.ref.tre -n conf.root.ref.tre -s alv_symbiont_ref_mafft.fasta

## reference package  create
taxit create -l 18S_V4_rRNA -P alv.18SV4.refpkg --aln-fasta alv_symbiont_ref_mafft.fasta --tree-stats RAxML_info.alv.red.tre --tree-file  RAxML_fastTreeSH_Support.conf.root.ref.tre


# ALVEOLATA ABUDANCE ANCOM ASV SEQUENCES
 
## Get the ASV sequences from ancom hit table 



## Clean the names

tr "[ -%,;\(\):=\.\\\*[]\"\']" "_" < ~/mergedRuns/TOTAL_sequences_qu39_merged/ancom_hit_ASV_seq > ancom_hit_ASV_seq.fasta

## Concatenate the query reads and reference alignment
# convert phylip format to to fasta in R and transfer back

cat alv_symbiont_ref_mafft.fasta ancom_hit_ASV_seq.fasta > alv_ANCOM_total_seq.fasta


## Align

mafft --thread 8 alv_ANCOM_total_seq.fasta >  alv_ANCOM_total_mafft.fasta

##pplacer
pplacer -o alv_ancom_ASV.jplace -p --keep-at-most 20 -c alv.18SV4.refpkg  alv_ANCOM_total_mafft.fasta

## Generate an easily parsed csv file of placements, with only a single placement reported for each
## query read.
guppy to_csv --point-mass --pp -o alv_ancom_ASV.csv alv_ancom_ASV.jplace 

## Generate a phyloxml tree with edges fattened according to the number of placements.
guppy fat --node-numbers --point-mass --pp -o alv_ancom_ASV.phyloxml alv_ancom_ASV.jplace 

guppy sing --node-numbers --point-mass --pp --out-dir ASVANCOM_tree alv_ancom_ASV.jplace 


